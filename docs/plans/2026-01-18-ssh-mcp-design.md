# SSH MCP 本地服务设计

日期：2026-01-18

## 目标与假设
- 目标：提供一个本地运行的 MCP 服务器，通过 SSH 安全地远程操控服务器。
- 假设：以 stdio 作为传输，单机单用户；连接信息由工具参数提供并保存在内存中；远端为类 Unix 系统为主，可选兼容 Windows。
- 范围：连接管理、命令执行、会话列表与关闭；在第一版不落盘保存凭据，避免引入本地凭据存储复杂度。

## 架构与组件
本服务采用 TypeScript 与 MCP SDK 构建，主入口负责初始化 `McpServer` 与 stdio 传输。核心组件分为三层：第一层是输入校验与工具编排，使用 Zod Schema 对参数进行严格校验并统一格式化输出；第二层是连接管理层，维护一个基于 `Map` 的会话注册表，记录 sessionId、连接配置与连接状态，并在连接关闭/异常时做清理；第三层是 SSH 执行层，封装 ssh2 Client 的连接与命令执行逻辑，提供统一的 `execCommand` 方法，并处理超时、输出截断与错误转换。为了保证易用性，工具以 `ssh_*` 前缀命名，并给出清晰的描述与示例。日志全部写入 stderr，stdout 仅输出 MCP 协议数据，符合本地 stdio 服务器的约束。

## 数据流与工具设计
工具层设计为四个原子能力：`ssh_connect` 创建连接并返回 sessionId；`ssh_exec` 在指定会话内执行命令，返回 stdout、stderr、exitCode 与是否截断；`ssh_list_sessions` 返回当前会话列表与状态；`ssh_disconnect` 关闭指定会话并释放资源。数据流为：用户调用 `ssh_connect` → 连接管理器创建并缓存连接 → `ssh_exec` 通过 sessionId 取回连接并执行命令 → 结果统一封装为 structuredContent 与文本输出。为了控制输出大小，在执行层加入字符上限与截断提示；对耗时命令可设置超时时间，超时触发关闭通道并尽量终止远端进程。所有工具均标注 readOnly/destructive/idempotent/openWorld 提示，帮助客户端理解风险与副作用。

## 错误处理与安全
错误处理统一在工具层捕获并转换为可行动的错误信息，例如“缺少 host/user”“命令为空”“连接超时”等，并保证不会把内部堆栈或敏感信息泄漏给调用者。输入校验禁止空命令、限制命令长度、校验端口范围，连接参数要求至少一种认证方式（password 或 privateKey）。日志中避免打印密码与私钥内容；私钥允许直接传入或通过路径读取，但读取失败会返回明确错误。超时策略在执行层进行，若超时则尝试关闭通道并返回提示，避免长时间挂起。会话清理在 `disconnect` 与进程退出时统一处理，确保资源释放。

## 测试与验证策略
遵循 TDD：先写测试、确认失败，再写最小实现。单元测试覆盖参数校验（空命令、长度限制、端口范围）、会话注册表的增删查与状态更新。集成测试使用 `ssh2` 的内置 Server 在测试进程内启动一个最小 SSH 服务，验证 `ssh_connect` 与 `ssh_exec` 的端到端行为（含超时与输出截断）。测试在 CI 与本地均可运行；如果没有 SSH 环境变量则自动跳过集成测试，并给出提示。构建验证包括 `npm test` 与 `npm run build`，确保 dist 产物可被 MCP 客户端启动。
